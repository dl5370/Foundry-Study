<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç­¾é’±åŒ… Web3 dApp - MultiSigWallet</title>
    <!-- ethers.js åº“ - ä¸» CDN + å¤‡ç”¨ CDN -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <script>
        // å¦‚æœä¸» CDN åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨ CDN
        if (typeof ethers === 'undefined') {
            console.warn('ä¸» CDN åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ CDN...');
            var script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
            script.onerror = function() {
                console.error('æ‰€æœ‰ CDN å‡åŠ è½½å¤±è´¥ï¼ŒåŠŸèƒ½å°†å—é™');
                document.body.innerHTML = '<div style="text-align: center; margin-top: 50px; font-size: 18px; color: red;"><p>âš ï¸ åº“åŠ è½½å¤±è´¥</p><p>æ— æ³•åŠ è½½ ethers.js åº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p></div>';
            };
            document.head.appendChild(script);
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .connection-status {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .card h3 {
            color: #764ba2;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .state-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: #f5f5f5;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .state-label {
            font-weight: bold;
            color: #333;
        }

        .state-value {
            color: #667eea;
            font-weight: bold;
            word-break: break-all;
        }

        .owner-section {
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .owner-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .confirmation-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        button {
            padding: 12px 24px;
            margin: 10px 0;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .notification {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .notification.warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #78350f;
        }

        .notification.error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #7f1d1d;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .threshold-status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
            font-size: 1.1em;
        }

        .threshold-status.not-ready {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        .threshold-status.ready {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
        }

        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            color: #333;
        }

        .balance-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .balance-item {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            text-align: center;
        }

        .balance-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .balance-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 5px;
        }

        .transaction-details {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e0e0e0;
        }

        .transaction-details p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ” å¤šç­¾é’±åŒ… Web3 dApp</h1>
            <p>MultiSigWallet - çœŸå®åŒºå—é“¾äº¤äº’</p>
        </div>

        <!-- Connection Status -->
        <div class="connection-status">
            <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ”Œ è¿æ¥çŠ¶æ€</h2>
            <div class="state-item">
                <span class="state-label">é’±åŒ…è¿æ¥:</span>
                <span class="state-value" id="walletConnection">æœªè¿æ¥</span>
            </div>
            <div class="state-item">
                <span class="state-label">å½“å‰è´¦æˆ·:</span>
                <span class="state-value" id="currentAccount">-</span>
            </div>
            <div class="state-item">
                <span class="state-label">ç½‘ç»œ:</span>
                <span class="state-value" id="network">-</span>
            </div>
            <button class="btn-primary" id="connectBtn" onclick="connectWallet()">è¿æ¥ MetaMask</button>
            <button class="btn-secondary" id="retryBtn" onclick="retryDetectMetaMask()" style="margin-top: 10px; background: #f0f0f0; color: #333;">ğŸ”„ é‡æ–°æ£€æŸ¥ MetaMask</button>
            <button class="btn-secondary" id="diagBtn" onclick="runDiagnostics()" style="margin-top: 10px; background: #f0f0f0; color: #333;">ğŸ”§ è¿è¡Œè¯Šæ–­</button>
        </div>

        <!-- Configuration -->
        <div class="card full-width">
            <h2>âš™ï¸ åˆçº¦é…ç½®</h2>
            <div class="info-box">
                <strong>ğŸ“ è¯´æ˜:</strong> éƒ¨ç½²åˆçº¦åï¼Œåœ¨ä¸‹æ–¹å¡«å…¥åˆçº¦åœ°å€
            </div>
            <div class="input-group">
                <label>MultiSigWallet åˆçº¦åœ°å€:</label>
                <input type="text" id="walletAddress" placeholder="0x...">
            </div>
            <div class="input-group">
                <label>MockERC20 ä»£å¸åœ°å€:</label>
                <input type="text" id="tokenAddress" placeholder="0x...">
            </div>
            <button class="btn-success" onclick="loadContracts()">åŠ è½½åˆçº¦</button>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Left Column: Wallet State -->
            <div class="card">
                <h2>ğŸ’¼ é’±åŒ…çŠ¶æ€</h2>

                <h3>é’±åŒ…åŸºæœ¬ä¿¡æ¯</h3>
                <div class="state-item">
                    <span class="state-label">æ‰€æœ‰è€…æ•°é‡:</span>
                    <span class="state-value" id="ownerCount">-</span>
                </div>
                <div class="state-item">
                    <span class="state-label">æ‰€éœ€ç­¾å:</span>
                    <span class="state-value" id="requiredSigs">-</span>
                </div>
                <div class="state-item">
                    <span class="state-label">äº¤æ˜“æ€»æ•°:</span>
                    <span class="state-value" id="txCount">-</span>
                </div>

                <h3>ä»£å¸ä½™é¢</h3>
                <div class="balance-display">
                    <div class="balance-item">
                        <div class="balance-label">é’±åŒ…</div>
                        <div class="balance-value" id="walletBalance">-</div>
                        <div class="balance-label">MTK</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">å½“å‰è´¦æˆ·</div>
                        <div class="balance-value" id="userBalance">-</div>
                        <div class="balance-label">MTK</div>
                    </div>
                </div>

                <button class="btn-primary" onclick="refreshState()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            </div>

            <!-- Right Column: Transaction Operations -->
            <div class="card">
                <h2>ğŸ’° äº¤æ˜“æ“ä½œ</h2>

                <h3>æäº¤æ–°äº¤æ˜“</h3>
                <div class="input-group">
                    <label>æ¥æ”¶åœ°å€:</label>
                    <input type="text" id="recipientAddress" placeholder="0x...">
                </div>
                <div class="input-group">
                    <label>è½¬è´¦é‡‘é¢ (MTK):</label>
                    <input type="number" id="transferAmount" placeholder="100" value="100">
                </div>
                <button class="btn-success" onclick="submitTransaction()">ğŸ“¤ æäº¤äº¤æ˜“</button>

                <h3>æŸ¥è¯¢äº¤æ˜“</h3>
                <div class="input-group">
                    <label>äº¤æ˜“ ID:</label>
                    <input type="number" id="queryTxId" placeholder="0" value="0">
                </div>
                <button class="btn-primary" onclick="queryTransaction()">ğŸ” æŸ¥è¯¢äº¤æ˜“</button>

                <div id="txDetails" class="transaction-details" style="display: none;">
                    <p><strong>äº¤æ˜“è¯¦æƒ…:</strong></p>
                    <p><strong>æ¥æ”¶åœ°å€:</strong> <span id="detailTo"></span></p>
                    <p><strong>é‡‘é¢:</strong> <span id="detailValue"></span> MTK</p>
                    <p><strong>ç¡®è®¤æ•°:</strong> <span id="detailConfirmations"></span></p>
                    <p><strong>å·²æ‰§è¡Œ:</strong> <span id="detailExecuted"></span></p>
                    <p><strong>å¯æ‰§è¡Œ:</strong> <span id="detailReady"></span></p>
                </div>
            </div>

            <!-- Confirmation Process -->
            <div class="card full-width">
                <h2>âœï¸ ç¡®è®¤ & æ‰§è¡Œ</h2>

                <div class="input-group">
                    <label>é€‰æ‹©äº¤æ˜“ ID:</label>
                    <input type="number" id="actionTxId" placeholder="0" value="0">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <button class="btn-success" onclick="confirmTx()">âœ… ç¡®è®¤äº¤æ˜“</button>
                    <button class="btn-danger" onclick="revokeTx()">âŒ æ’¤é”€ç¡®è®¤</button>
                    <button class="btn-warning" onclick="executeTx()">âš¡ æ‰§è¡Œäº¤æ˜“</button>
                </div>

                <div id="thresholdNotification" class="notification warning" style="display: none;">
                    <strong>ğŸ”” é€šçŸ¥:</strong> <span id="notificationText"></span>
                </div>
            </div>

            <!-- Event Log -->
            <div class="card full-width">
                <h2>ğŸ“ äº‹ä»¶æ—¥å¿—</h2>
                <button class="btn-primary" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                <div id="eventLog" style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                    <div style="color: #999; text-align: center; padding: 20px;">
                        ç­‰å¾…äº‹ä»¶...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract ABIs
        const MULTISIG_ABI = [
            "function owners(uint256) view returns (address)",
            "function required() view returns (uint256)",
            "function getOwners() view returns (address[])",
            "function getTransactionCount() view returns (uint256)",
            "function getTransaction(uint256) view returns (address token, address to, uint256 value, bytes data, bool executed, uint256 numConfirmations)",
            "function isTransactionReady(uint256) view returns (bool)",
            "function getConfirmations(uint256) view returns (address[])",
            "function submitTransaction(address token, address to, uint256 value, bytes data)",
            "function confirmTransaction(uint256 txId)",
            "function revokeConfirmation(uint256 txId)",
            "function executeTransaction(uint256 txId)",
            "event SubmitTransaction(uint256 indexed txId, address indexed token, address indexed to, uint256 value, bytes data)",
            "event ConfirmTransaction(address indexed owner, uint256 indexed txId)",
            "event RevokeConfirmation(address indexed owner, uint256 indexed txId)",
            "event ExecuteTransaction(uint256 indexed txId)",
            "event ConfirmationThresholdReached(uint256 indexed txId, uint256 numConfirmations)"
        ];

        const ERC20_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function balanceOf(address) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function mint(address to, uint256 amount)"
        ];

        // Global state
        let provider;
        let signer;
        let currentAccount;
        let walletContract;
        let tokenContract;
        let eventLog = [];

        // Diagnostic function for debugging
        function runDiagnostics() {
            addLog('è¯Šæ–­', '=== å¼€å§‹ç³»ç»Ÿè¯Šæ–­ ===');

            // æ£€æŸ¥ ethers.js
            if (typeof ethers !== 'undefined') {
                addLog('è¯Šæ–­', 'âœ… ethers.js åº“å·²åŠ è½½');
            } else {
                addLog('è¯Šæ–­', 'âŒ ethers.js åº“æœªåŠ è½½ï¼ˆå°†å°è¯•å¤‡ç”¨ CDNï¼‰');
            }

            // æ£€æŸ¥ window.ethereum
            if (typeof window.ethereum !== 'undefined') {
                addLog('è¯Šæ–­', 'âœ… window.ethereum å¯¹è±¡å·²æ£€æµ‹åˆ°');
                addLog('è¯Šæ–­', `   - isMetaMask: ${window.ethereum.isMetaMask || 'N/A'}`);
                addLog('è¯Šæ–­', `   - networkVersion: ${window.ethereum.networkVersion || 'N/A'}`);
                addLog('è¯Šæ–­', `   - chainId: ${window.ethereum.chainId || 'N/A'}`);
            } else {
                addLog('è¯Šæ–­', 'âŒ window.ethereum æœªæ£€æµ‹åˆ° - Chrome å¯èƒ½é˜»æ­¢äº† MetaMask è®¿é—®');
                addLog('è¯Šæ–­', '   è§£å†³æ–¹æ¡ˆï¼š');
                addLog('è¯Šæ–­', '   1ï¸âƒ£ æ‰“å¼€ Chrome åœ°å€æ å³ä¾§çš„é”å›¾æ ‡ ğŸ”’');
                addLog('è¯Šæ–­', '   2ï¸âƒ£ ç‚¹å‡»"æ‰©å±•ç¨‹åºè®¿é—®æƒé™"æˆ–"ç½‘ç«™è®¾ç½®"');
                addLog('è¯Šæ–­', '   3ï¸âƒ£ å°† MetaMask æ”¹ä¸º"å…è®¸æ­¤ç½‘ç«™"æˆ–"å¯ç”¨"');
                addLog('è¯Šæ–­', '   4ï¸âƒ£ åˆ·æ–°é¡µé¢åé‡è¯•');
            }

            // æ£€æŸ¥æµè§ˆå™¨
            addLog('è¯Šæ–­', `æµè§ˆå™¨: ${navigator.userAgent.split(' ').pop()}`);
            addLog('è¯Šæ–­', '=== è¯Šæ–­å®Œæˆ ===');
        }

        // Initialize
        window.addEventListener('load', () => {
            addLog('ç³»ç»Ÿ', 'Web3 dApp å·²åŠ è½½ï¼Œæ£€æŸ¥ MetaMask...');

            // Run diagnostics first
            setTimeout(() => {
                runDiagnostics();
            }, 100);

            // Check if MetaMask is installed with retry logic
            checkMetaMaskWithRetry();
        });

        // Function to check MetaMask with extended retry logic
        function checkMetaMaskWithRetry() {
            let retryCount = 0;
            const maxRetries = 3;
            const delayMs = [0, 500, 1000];

            function attemptCheck(attempt) {
                if (typeof window.ethereum !== 'undefined') {
                    addLog('ç³»ç»Ÿ', 'âœ… æ£€æµ‹åˆ° MetaMask æ‰©å±•');

                    // Auto-fill contract addresses
                    document.getElementById('walletAddress').value = '0x5FbDB2315678afecb367f032d93F642f64180aa3';
                    document.getElementById('tokenAddress').value = '0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512';
                    addLog('ç³»ç»Ÿ', 'âœ… å·²è‡ªåŠ¨å¡«å……åˆçº¦åœ°å€');
                    return;
                }

                if (attempt < maxRetries) {
                    const nextDelay = delayMs[attempt + 1];
                    addLog('ç³»ç»Ÿ', `â³ MetaMask æ£€æµ‹ä¸­ï¼Œè¯·ç¨å€™... (${nextDelay}ms)`);

                    setTimeout(() => {
                        attemptCheck(attempt + 1);
                    }, nextDelay);
                } else {
                    addLog('é”™è¯¯', 'âŒ æœªæ£€æµ‹åˆ° MetaMaskï¼Œè¯·å®‰è£… MetaMask æ‰©å±•');
                    addLog('æç¤º', 'ğŸ’¡ å¦‚æœå·²å®‰è£… MetaMaskï¼Œè¯·ç‚¹å‡»"ğŸ”„ é‡æ–°æ£€æŸ¥ MetaMask"æŒ‰é’®');
                }
            }

            attemptCheck(0);
        }

        // Function to manually retry MetaMask detection with extended retries
        function retryDetectMetaMask() {
            addLog('ç³»ç»Ÿ', 'æ­£åœ¨é‡æ–°æ£€æŸ¥ MetaMaskï¼ˆæœ€å¤šé‡è¯• 5 æ¬¡ï¼‰...');
            console.log('window.ethereum:', window.ethereum);
            console.log('window.MetaMaskOnboarding:', typeof window.MetaMaskOnboarding);

            let retryCount = 0;
            const maxRetries = 5;
            const delayMs = [0, 500, 1000, 2000, 3000]; // ç´¯è¿›å»¶è¿Ÿ

            function attemptDetection(attempt) {
                retryCount = attempt;

                // Direct check
                if (typeof window.ethereum !== 'undefined') {
                    addLog('æˆåŠŸ', `âœ… MetaMask æ£€æµ‹æˆåŠŸï¼ˆç¬¬ ${attempt} æ¬¡å°è¯•ï¼‰`);
                    completeMetaMaskDetection();
                    return;
                }

                // Check isMetaMask property
                if (window.ethereum?.isMetaMask) {
                    addLog('æˆåŠŸ', `âœ… MetaMask æ£€æµ‹æˆåŠŸï¼ˆç¬¬ ${attempt} æ¬¡å°è¯•ï¼‰`);
                    completeMetaMaskDetection();
                    return;
                }

                // Continue retrying if we haven't reached max retries
                if (attempt < maxRetries) {
                    const nextDelay = delayMs[attempt + 1];
                    addLog('ç³»ç»Ÿ', `â³ ç­‰å¾… ${nextDelay}ms åè¿›è¡Œç¬¬ ${attempt + 2} æ¬¡å°è¯•...`);
                    console.log(`Attempt ${attempt + 1}/${maxRetries} - scheduling next attempt in ${nextDelay}ms`);

                    setTimeout(() => {
                        attemptDetection(attempt + 1);
                    }, nextDelay);
                } else {
                    // All retries exhausted
                    showMetaMaskNotFoundAlert();
                }
            }

            // Start with first attempt
            attemptDetection(0);
        }

        function completeMetaMaskDetection() {
            addLog('æˆåŠŸ', 'âœ… æ£€æµ‹åˆ° MetaMaskï¼');

            // Auto-fill contract addresses
            document.getElementById('walletAddress').value = '0x5FbDB2315678afecb367f032d93F642f64180aa3';
            document.getElementById('tokenAddress').value = '0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512';
            addLog('ç³»ç»Ÿ', 'âœ… å·²è‡ªåŠ¨å¡«å……åˆçº¦åœ°å€');

            alert('âœ… MetaMask æ£€æµ‹æˆåŠŸï¼\n\nç°åœ¨è¯·ç‚¹å‡»"è¿æ¥ MetaMask"æŒ‰é’®è¿æ¥ä½ çš„é’±åŒ…ã€‚');
        }

        function showMetaMaskNotFoundAlert() {
            addLog('é”™è¯¯', 'âŒ ä»æœªæ£€æµ‹åˆ° MetaMask');

            const debugInfo = `
ğŸ†˜ MetaMask æœªæ£€æµ‹åˆ°

å¯èƒ½çš„åŸå› ï¼š
1. MetaMask æ‰©å±•è¢«ç¦ç”¨äº†
2. æµè§ˆå™¨é˜»æ­¢äº† MetaMask è®¿é—®æ­¤ç½‘ç«™
3. MetaMask æœªæ­£ç¡®åŠ è½½

è§£å†³æ–¹æ¡ˆï¼ˆæŒ‰é¡ºåºå°è¯•ï¼‰ï¼š

A. æ£€æŸ¥ MetaMask çŠ¶æ€ï¼š
   â€¢ ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’çš„æ‰©å±•å›¾æ ‡ ğŸ§©
   â€¢ ç¡®ä¿ MetaMask æ˜¯å¯ç”¨çŠ¶æ€ï¼ˆä¸æ˜¯ç°è‰²ï¼‰
   â€¢ ç‚¹å‡» MetaMask å›¾æ ‡ç¡®ä¿é’±åŒ…èƒ½æ‰“å¼€

B. å…è®¸ç½‘ç«™è®¿é—® MetaMaskï¼š
   â€¢ ç‚¹å‡»åœ°å€æ å³ä¾§çš„é”å›¾æ ‡ ğŸ”’
   â€¢ é€‰æ‹©"ç½‘ç«™è®¾ç½®"
   â€¢ æ‰¾åˆ°"æ‰©å±•ç¨‹åºè®¿é—®æƒé™"
   â€¢ ç¡®ä¿ MetaMask æ”¹ä¸º"å…è®¸æ­¤ç½‘ç«™"

C. å¦‚æœè¿˜ä¸è¡Œï¼š
   â€¢ å…³é—­æµè§ˆå™¨æ‰€æœ‰ Chrome çª—å£
   â€¢ é‡æ–°æ‰“å¼€æµè§ˆå™¨
   â€¢ æ‰“å¼€æ­¤ç½‘é¡µ
   â€¢ ç‚¹å‡»"é‡æ–°æ£€æŸ¥ MetaMask"

D. æœ€åæ–¹æ¡ˆï¼š
   â€¢ ç¦ç”¨å…¶ä»–æ‰©å±•ï¼ˆå¯èƒ½æœ‰å†²çªï¼‰
   â€¢ é‡æ–°å®‰è£… MetaMask æ‰©å±•
            `;

            alert(debugInfo);
        }

        async function connectWallet() {
            try {
                // Check 1: MetaMask installed? (with retry)
                if (typeof window.ethereum === 'undefined') {
                    addLog('ç³»ç»Ÿ', 'ç¬¬ä¸€æ¬¡æ£€æµ‹æœªæ‰¾åˆ° MetaMaskï¼Œè¿›è¡Œå»¶è¿Ÿé‡è¯•...');
                    console.log('First check failed, retrying...');

                    // Retry after a short delay
                    await new Promise(resolve => setTimeout(resolve, 500));

                    if (typeof window.ethereum === 'undefined') {
                        // Still not found - show installation guide
                        const installMsg = `ğŸ¦Š æœªæ£€æµ‹åˆ° MetaMask é’±åŒ…æ‰©å±•ï¼\n\n` +
                            `MetaMask æ˜¯ä¸€ä¸ªæµè§ˆå™¨æ‰©å±•ï¼Œç”¨äºè¿æ¥åŒºå—é“¾åº”ç”¨ã€‚\n\n` +
                            `è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å®‰è£…ï¼š\n\n` +
                            `1. è®¿é—® MetaMask å®˜ç½‘: https://metamask.io/\n` +
                            `2. ç‚¹å‡» "Download" ä¸‹è½½é€‚åˆä½ æµè§ˆå™¨çš„ç‰ˆæœ¬\n` +
                            `3. å®‰è£…å®Œæˆåï¼Œåˆ·æ–°æ­¤é¡µé¢\n\n` +
                            `æ”¯æŒçš„æµè§ˆå™¨: Chrome, Firefox, Brave, Edge`;
                        alert(installMsg);
                        addLog('é”™è¯¯', 'æœªå®‰è£… MetaMaskï¼Œè¯·è®¿é—® https://metamask.io/ ä¸‹è½½å®‰è£…');
                        // Open MetaMask download page
                        window.open('https://metamask.io/download/', '_blank');
                        return;
                    }
                }

                addLog('ç³»ç»Ÿ', 'âœ… å·²ç¡®è®¤æ£€æµ‹åˆ° MetaMask');
                addLog('æç¤º', 'æ­£åœ¨è¯·æ±‚è¿æ¥ MetaMask...');
                console.log('MetaMask detected, requesting accounts...');

                // Request account access - MetaMask will handle login/setup
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

                if (!accounts || accounts.length === 0) {
                    addLog('é”™è¯¯', 'æœªè·å¾—è´¦æˆ·åˆ—è¡¨');
                    alert('âŒ æœªè·å¾—è´¦æˆ·ä¿¡æ¯\n\nè¯·ç¡®ä¿åœ¨ MetaMask å¼¹çª—ä¸­é€‰æ‹©äº†è´¦æˆ·å¹¶ç‚¹å‡»"è¿æ¥"ã€‚');
                    return;
                }

                console.log('Accounts received:', accounts);
                addLog('æˆåŠŸ', `âœ… å·²è·å¾—è´¦æˆ·: ${accounts[0]}`);

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                currentAccount = await signer.getAddress();

                console.log('Current account:', currentAccount);
                addLog('æˆåŠŸ', `âœ… å·²è¿æ¥åˆ°è´¦æˆ·: ${currentAccount}`);

                // Get network
                const network = await provider.getNetwork();
                console.log('Network:', network);
                addLog('æˆåŠŸ', `âœ… ç½‘ç»œ: ${network.name} (Chain ID: ${network.chainId})`);

                // Update UI
                document.getElementById('walletConnection').textContent = 'âœ… å·²è¿æ¥';
                document.getElementById('currentAccount').textContent = currentAccount;
                document.getElementById('network').textContent = `${network.name} (Chain ID: ${network.chainId})`;
                document.getElementById('connectBtn').textContent = 'âœ… å·²è¿æ¥';
                document.getElementById('connectBtn').disabled = true;

                addLog('è¿æ¥', `âœ… å·²è¿æ¥è´¦æˆ·: ${currentAccount}`);
                addLog('ç½‘ç»œ', `âœ… ${network.name} (Chain ID: ${network.chainId})`);

                // Auto-load contracts after connecting
                setTimeout(() => {
                    addLog('ç³»ç»Ÿ', 'æ­£åœ¨è‡ªåŠ¨åŠ è½½åˆçº¦...');
                    loadContracts();
                }, 500);

                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        addLog('æ–­å¼€', 'è´¦æˆ·å·²æ–­å¼€');
                        location.reload();
                    } else {
                        currentAccount = accounts[0];
                        document.getElementById('currentAccount').textContent = currentAccount;
                        addLog('åˆ‡æ¢', `åˆ‡æ¢åˆ°è´¦æˆ·: ${currentAccount}`);
                        refreshState();
                    }
                });

                // Listen for chain changes
                window.ethereum.on('chainChanged', () => {
                    addLog('æç¤º', 'ç½‘ç»œå·²æ”¹å˜ï¼Œæ­£åœ¨é‡æ–°åŠ è½½...');
                    location.reload();
                });

            } catch (error) {
                console.error('Connection error:', error);

                // Handle different error cases
                if (error.code === 4001) {
                    // User rejected the connection request
                    addLog('å–æ¶ˆ', 'ç”¨æˆ·å–æ¶ˆäº†è¿æ¥è¯·æ±‚');
                    alert('âŒ è¿æ¥å·²å–æ¶ˆ\n\næ‚¨æ‹’ç»äº†è¿æ¥è¯·æ±‚ã€‚å¦‚éœ€ä½¿ç”¨æœ¬åº”ç”¨ï¼Œè¯·ç‚¹å‡»"è¿æ¥ MetaMask"å¹¶åœ¨ MetaMask å¼¹çª—ä¸­ç‚¹å‡»"è¿æ¥"ã€‚');
                } else if (error.code === -32002) {
                    // Request already pending
                    addLog('ç­‰å¾…', 'å·²æœ‰å¾…å¤„ç†çš„è¿æ¥è¯·æ±‚');
                    alert('â³ è¯·æ±‚å¤„ç†ä¸­\n\nè¯·åœ¨ MetaMask å¼¹çª—ä¸­å®Œæˆæ“ä½œã€‚\nå¦‚æœçœ‹ä¸åˆ°å¼¹çª—ï¼Œè¯·ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’çš„ MetaMask å›¾æ ‡ã€‚');
                } else if (error.message && error.message.includes('Already processing')) {
                    addLog('ç­‰å¾…', 'MetaMask æ­£åœ¨å¤„ç†å…¶ä»–è¯·æ±‚');
                    alert('â³ MetaMask ç¹å¿™\n\nè¯·ç¨å€™ç‰‡åˆ»ï¼Œç„¶åé‡è¯•ã€‚\nç¡®ä¿å·²å®Œæˆå…¶ä»–æ­£åœ¨è¿›è¡Œçš„æ“ä½œã€‚');
                } else if (error.message && error.message.includes('User closed modal')) {
                    addLog('å–æ¶ˆ', 'ç”¨æˆ·å…³é—­äº† MetaMask å¼¹çª—');
                    alert('âŒ æ“ä½œå·²å–æ¶ˆ\n\næ‚¨å…³é—­äº† MetaMask çª—å£ã€‚è¯·é‡æ–°ç‚¹å‡»"è¿æ¥ MetaMask"å®Œæˆè¿æ¥ã€‚');
                } else if (error.code === -32603 || (error.message && (
                    error.message.includes('wallet_requestPermissions') ||
                    error.message.includes('Request of type') ||
                    error.message.toLowerCase().includes('unauthorized')
                ))) {
                    // MetaMask is locked or not initialized
                    addLog('æç¤º', 'MetaMask éœ€è¦è§£é”æˆ–åˆå§‹åŒ–');
                    const unlockMsg = `ğŸ”’ MetaMask æœªå°±ç»ª\n\n` +
                        `è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š\n\n` +
                        `1ï¸âƒ£ å¦‚æœ MetaMask å·²é”å®šï¼š\n` +
                        `   â€¢ ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’çš„ MetaMask å›¾æ ‡\n` +
                        `   â€¢ è¾“å…¥å¯†ç è§£é”é’±åŒ…\n` +
                        `   â€¢ ç„¶åé‡æ–°ç‚¹å‡»"è¿æ¥ MetaMask"æŒ‰é’®\n\n` +
                        `2ï¸âƒ£ å¦‚æœæ˜¯é¦–æ¬¡ä½¿ç”¨ MetaMaskï¼š\n` +
                        `   â€¢ ç‚¹å‡» MetaMask å›¾æ ‡\n` +
                        `   â€¢ é€‰æ‹©"åˆ›å»ºæ–°é’±åŒ…"æˆ–"å¯¼å…¥å·²æœ‰é’±åŒ…"\n` +
                        `   â€¢ å®Œæˆè®¾ç½®åé‡æ–°è¿æ¥\n\n` +
                        `3ï¸âƒ£ æœ¬åº”ç”¨ä½¿ç”¨æœ¬åœ°æµ‹è¯•ç½‘ç»œ(localhost:8545)\n` +
                        `   â€¢ éœ€è¦å¯¼å…¥æµ‹è¯•è´¦æˆ·ç§é’¥\n` +
                        `   â€¢ æµ‹è¯•ç½‘ç»œ Chain ID: 31337`;
                    alert(unlockMsg);
                } else {
                    // Other errors
                    addLog('é”™è¯¯', `è¿æ¥å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
                    const errorMsg = `âš ï¸ è¿æ¥å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}\n\n` +
                        `å¸¸è§è§£å†³æ–¹æ³•ï¼š\n` +
                        `1. ç¡®ä¿ MetaMask å·²è§£é”ï¼ˆç‚¹å‡»å³ä¸Šè§’å›¾æ ‡ç™»å½•ï¼‰\n` +
                        `2. åˆ·æ–°é¡µé¢åé‡è¯•\n` +
                        `3. æ£€æŸ¥ MetaMask æ˜¯å¦æ­£å¸¸å·¥ä½œ\n\n` +
                        `è¯¦ç»†é”™è¯¯ä¿¡æ¯è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å° (F12)`;
                    alert(errorMsg);
                }
            }
        }

        async function loadContracts() {
            try {
                if (!signer) {
                    alert('è¯·å…ˆè¿æ¥ MetaMask');
                    return;
                }

                const walletAddr = document.getElementById('walletAddress').value.trim();
                const tokenAddr = document.getElementById('tokenAddress').value.trim();

                if (!walletAddr || !tokenAddr) {
                    alert('è¯·å¡«å…¥åˆçº¦åœ°å€');
                    return;
                }

                // Load contracts
                walletContract = new ethers.Contract(walletAddr, MULTISIG_ABI, signer);
                tokenContract = new ethers.Contract(tokenAddr, ERC20_ABI, signer);

                addLog('åˆçº¦', `MultiSigWallet å·²åŠ è½½: ${walletAddr}`);
                addLog('åˆçº¦', `MockERC20 å·²åŠ è½½: ${tokenAddr}`);

                // Setup event listeners
                setupEventListeners();

                // Refresh state
                await refreshState();

                alert('åˆçº¦åŠ è½½æˆåŠŸï¼');

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `åŠ è½½åˆçº¦å¤±è´¥: ${error.message}`);
                alert('åŠ è½½åˆçº¦å¤±è´¥: ' + error.message);
            }
        }

        function setupEventListeners() {
            // Listen for ConfirmationThresholdReached event
            walletContract.on("ConfirmationThresholdReached", (txId, numConfirmations) => {
                addLog('äº‹ä»¶', `ğŸ”” äº¤æ˜“ #${txId} å·²è¾¾åˆ°é˜ˆå€¼! (${numConfirmations} ä¸ªç¡®è®¤)`);
                showNotification(`äº¤æ˜“ #${txId} å·²è¾¾åˆ°é˜ˆå€¼ï¼Œå¯ä»¥æ‰§è¡Œäº†ï¼`);
                refreshState();
            });

            // Listen for other events
            walletContract.on("SubmitTransaction", (txId, token, to, value, data) => {
                addLog('äº‹ä»¶', `æäº¤äº¤æ˜“ #${txId} (å‘é€ ${ethers.utils.formatEther(value)} MTK åˆ° ${to})`);
                refreshState();
            });

            walletContract.on("ConfirmTransaction", (owner, txId) => {
                addLog('äº‹ä»¶', `${owner} ç¡®è®¤äº†äº¤æ˜“ #${txId}`);
                refreshState();
            });

            walletContract.on("RevokeConfirmation", (owner, txId) => {
                addLog('äº‹ä»¶', `${owner} æ’¤é”€äº†äº¤æ˜“ #${txId} çš„ç¡®è®¤`);
                refreshState();
            });

            walletContract.on("ExecuteTransaction", (txId) => {
                addLog('äº‹ä»¶', `âœ… äº¤æ˜“ #${txId} å·²æ‰§è¡Œ`);
                refreshState();
            });
        }

        async function refreshState() {
            try {
                if (!walletContract || !tokenContract) {
                    return;
                }

                // Get wallet info
                const owners = await walletContract.getOwners();
                const required = await walletContract.required();
                const txCount = await walletContract.getTransactionCount();

                document.getElementById('ownerCount').textContent = owners.length;
                document.getElementById('requiredSigs').textContent = `${required} of ${owners.length}`;
                document.getElementById('txCount').textContent = txCount.toString();

                // Get balances
                const walletBalance = await tokenContract.balanceOf(walletContract.address);
                const userBalance = await tokenContract.balanceOf(currentAccount);

                document.getElementById('walletBalance').textContent = ethers.utils.formatEther(walletBalance);
                document.getElementById('userBalance').textContent = ethers.utils.formatEther(userBalance);

                addLog('åˆ·æ–°', 'çŠ¶æ€å·²æ›´æ–°');

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `åˆ·æ–°çŠ¶æ€å¤±è´¥: ${error.message}`);
            }
        }

        async function submitTransaction() {
            try {
                if (!walletContract || !tokenContract) {
                    alert('è¯·å…ˆåŠ è½½åˆçº¦');
                    return;
                }

                const recipient = document.getElementById('recipientAddress').value.trim();
                const amount = document.getElementById('transferAmount').value;

                if (!recipient || !amount) {
                    alert('è¯·å¡«å†™æ¥æ”¶åœ°å€å’Œé‡‘é¢');
                    return;
                }

                addLog('æäº¤', 'æ­£åœ¨æäº¤äº¤æ˜“...');

                const amountWei = ethers.utils.parseEther(amount);
                const tx = await walletContract.submitTransaction(
                    tokenContract.address,
                    recipient,
                    amountWei,
                    "0x"
                );

                addLog('äº¤æ˜“', `äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`);

                const receipt = await tx.wait();
                addLog('æˆåŠŸ', 'äº¤æ˜“å·²æäº¤ï¼');

                await refreshState();

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `æäº¤å¤±è´¥: ${error.message}`);
                alert('æäº¤äº¤æ˜“å¤±è´¥: ' + error.message);
            }
        }

        async function queryTransaction() {
            try {
                if (!walletContract) {
                    alert('è¯·å…ˆåŠ è½½åˆçº¦');
                    return;
                }

                const txId = document.getElementById('queryTxId').value;

                const tx = await walletContract.getTransaction(txId);
                const isReady = await walletContract.isTransactionReady(txId);

                document.getElementById('detailTo').textContent = tx.to;
                document.getElementById('detailValue').textContent = ethers.utils.formatEther(tx.value);
                document.getElementById('detailConfirmations').textContent = tx.numConfirmations.toString();
                document.getElementById('detailExecuted').textContent = tx.executed ? 'âœ… æ˜¯' : 'âŒ å¦';
                document.getElementById('detailReady').textContent = isReady ? 'âœ… æ˜¯' : 'âŒ å¦';

                document.getElementById('txDetails').style.display = 'block';

                addLog('æŸ¥è¯¢', `äº¤æ˜“ #${txId} è¯¦æƒ…å·²æ˜¾ç¤º`);

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `æŸ¥è¯¢å¤±è´¥: ${error.message}`);
                alert('æŸ¥è¯¢äº¤æ˜“å¤±è´¥: ' + error.message);
            }
        }

        async function confirmTx() {
            try {
                if (!walletContract) {
                    alert('è¯·å…ˆåŠ è½½åˆçº¦');
                    return;
                }

                const txId = document.getElementById('actionTxId').value;

                addLog('ç¡®è®¤', `æ­£åœ¨ç¡®è®¤äº¤æ˜“ #${txId}...`);

                const tx = await walletContract.confirmTransaction(txId);
                addLog('äº¤æ˜“', `äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`);

                await tx.wait();
                addLog('æˆåŠŸ', `äº¤æ˜“ #${txId} å·²ç¡®è®¤ï¼`);

                await refreshState();

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `ç¡®è®¤å¤±è´¥: ${error.message}`);
                alert('ç¡®è®¤äº¤æ˜“å¤±è´¥: ' + error.message);
            }
        }

        async function revokeTx() {
            try {
                if (!walletContract) {
                    alert('è¯·å…ˆåŠ è½½åˆçº¦');
                    return;
                }

                const txId = document.getElementById('actionTxId').value;

                addLog('æ’¤é”€', `æ­£åœ¨æ’¤é”€äº¤æ˜“ #${txId} çš„ç¡®è®¤...`);

                const tx = await walletContract.revokeConfirmation(txId);
                addLog('äº¤æ˜“', `äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`);

                await tx.wait();
                addLog('æˆåŠŸ', `äº¤æ˜“ #${txId} çš„ç¡®è®¤å·²æ’¤é”€ï¼`);

                await refreshState();

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `æ’¤é”€å¤±è´¥: ${error.message}`);
                alert('æ’¤é”€ç¡®è®¤å¤±è´¥: ' + error.message);
            }
        }

        async function executeTx() {
            try {
                if (!walletContract) {
                    alert('è¯·å…ˆåŠ è½½åˆçº¦');
                    return;
                }

                const txId = document.getElementById('actionTxId').value;

                addLog('æ‰§è¡Œ', `æ­£åœ¨æ‰§è¡Œäº¤æ˜“ #${txId}...`);

                const tx = await walletContract.executeTransaction(txId);
                addLog('äº¤æ˜“', `äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`);

                await tx.wait();
                addLog('æˆåŠŸ', `âœ… äº¤æ˜“ #${txId} å·²æ‰§è¡Œï¼`);

                await refreshState();

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `æ‰§è¡Œå¤±è´¥: ${error.message}`);
                alert('æ‰§è¡Œäº¤æ˜“å¤±è´¥: ' + error.message);
            }
        }

        function addLog(action, details) {
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            eventLog.unshift(`[${timestamp}] ${action}: ${details}`);
            updateEventLog();
        }

        function updateEventLog() {
            const logDiv = document.getElementById('eventLog');
            if (eventLog.length === 0) {
                logDiv.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">ç­‰å¾…äº‹ä»¶...</div>';
            } else {
                logDiv.innerHTML = eventLog.map(e =>
                    `<div style="padding: 8px; border-bottom: 1px solid #eee; font-family: monospace; font-size: 0.9em;">${e}</div>`
                ).join('');
            }
        }

        function clearLog() {
            eventLog = [];
            updateEventLog();
        }

        function showNotification(message) {
            const notif = document.getElementById('thresholdNotification');
            document.getElementById('notificationText').textContent = message;
            notif.style.display = 'block';

            setTimeout(() => {
                notif.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
