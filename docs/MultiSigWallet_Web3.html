<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç­¾é’±åŒ… Web3 dApp - MultiSigWallet</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .connection-status {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .card h3 {
            color: #764ba2;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .state-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: #f5f5f5;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .state-label {
            font-weight: bold;
            color: #333;
        }

        .state-value {
            color: #667eea;
            font-weight: bold;
            word-break: break-all;
        }

        .owner-section {
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .owner-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .confirmation-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        button {
            padding: 12px 24px;
            margin: 10px 0;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .notification {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .notification.warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #78350f;
        }

        .notification.error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #7f1d1d;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .threshold-status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
            font-size: 1.1em;
        }

        .threshold-status.not-ready {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        .threshold-status.ready {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
        }

        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            color: #333;
        }

        .balance-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .balance-item {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            text-align: center;
        }

        .balance-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .balance-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 5px;
        }

        .transaction-details {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e0e0e0;
        }

        .transaction-details p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ” å¤šç­¾é’±åŒ… Web3 dApp</h1>
            <p>MultiSigWallet - çœŸå®åŒºå—é“¾äº¤äº’</p>
        </div>

        <!-- Connection Status -->
        <div class="connection-status">
            <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ”Œ è¿æ¥çŠ¶æ€</h2>
            <div class="state-item">
                <span class="state-label">é’±åŒ…è¿æ¥:</span>
                <span class="state-value" id="walletConnection">æœªè¿æ¥</span>
            </div>
            <div class="state-item">
                <span class="state-label">å½“å‰è´¦æˆ·:</span>
                <span class="state-value" id="currentAccount">-</span>
            </div>
            <div class="state-item">
                <span class="state-label">ç½‘ç»œ:</span>
                <span class="state-value" id="network">-</span>
            </div>
            <button class="btn-primary" id="connectBtn" onclick="connectWallet()">è¿æ¥ MetaMask</button>
        </div>

        <!-- Configuration -->
        <div class="card full-width">
            <h2>âš™ï¸ åˆçº¦é…ç½®</h2>
            <div class="info-box">
                <strong>ğŸ“ è¯´æ˜:</strong> éƒ¨ç½²åˆçº¦åï¼Œåœ¨ä¸‹æ–¹å¡«å…¥åˆçº¦åœ°å€
            </div>
            <div class="input-group">
                <label>MultiSigWallet åˆçº¦åœ°å€:</label>
                <input type="text" id="walletAddress" placeholder="0x...">
            </div>
            <div class="input-group">
                <label>MockERC20 ä»£å¸åœ°å€:</label>
                <input type="text" id="tokenAddress" placeholder="0x...">
            </div>
            <button class="btn-success" onclick="loadContracts()">åŠ è½½åˆçº¦</button>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Left Column: Wallet State -->
            <div class="card">
                <h2>ğŸ’¼ é’±åŒ…çŠ¶æ€</h2>

                <h3>é’±åŒ…åŸºæœ¬ä¿¡æ¯</h3>
                <div class="state-item">
                    <span class="state-label">æ‰€æœ‰è€…æ•°é‡:</span>
                    <span class="state-value" id="ownerCount">-</span>
                </div>
                <div class="state-item">
                    <span class="state-label">æ‰€éœ€ç­¾å:</span>
                    <span class="state-value" id="requiredSigs">-</span>
                </div>
                <div class="state-item">
                    <span class="state-label">äº¤æ˜“æ€»æ•°:</span>
                    <span class="state-value" id="txCount">-</span>
                </div>

                <h3>ä»£å¸ä½™é¢</h3>
                <div class="balance-display">
                    <div class="balance-item">
                        <div class="balance-label">é’±åŒ…</div>
                        <div class="balance-value" id="walletBalance">-</div>
                        <div class="balance-label">MTK</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">å½“å‰è´¦æˆ·</div>
                        <div class="balance-value" id="userBalance">-</div>
                        <div class="balance-label">MTK</div>
                    </div>
                </div>

                <button class="btn-primary" onclick="refreshState()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            </div>

            <!-- Right Column: Transaction Operations -->
            <div class="card">
                <h2>ğŸ’° äº¤æ˜“æ“ä½œ</h2>

                <h3>æäº¤æ–°äº¤æ˜“</h3>
                <div class="input-group">
                    <label>æ¥æ”¶åœ°å€:</label>
                    <input type="text" id="recipientAddress" placeholder="0x...">
                </div>
                <div class="input-group">
                    <label>è½¬è´¦é‡‘é¢ (MTK):</label>
                    <input type="number" id="transferAmount" placeholder="100" value="100">
                </div>
                <button class="btn-success" onclick="submitTransaction()">ğŸ“¤ æäº¤äº¤æ˜“</button>

                <h3>æŸ¥è¯¢äº¤æ˜“</h3>
                <div class="input-group">
                    <label>äº¤æ˜“ ID:</label>
                    <input type="number" id="queryTxId" placeholder="0" value="0">
                </div>
                <button class="btn-primary" onclick="queryTransaction()">ğŸ” æŸ¥è¯¢äº¤æ˜“</button>

                <div id="txDetails" class="transaction-details" style="display: none;">
                    <p><strong>äº¤æ˜“è¯¦æƒ…:</strong></p>
                    <p><strong>æ¥æ”¶åœ°å€:</strong> <span id="detailTo"></span></p>
                    <p><strong>é‡‘é¢:</strong> <span id="detailValue"></span> MTK</p>
                    <p><strong>ç¡®è®¤æ•°:</strong> <span id="detailConfirmations"></span></p>
                    <p><strong>å·²æ‰§è¡Œ:</strong> <span id="detailExecuted"></span></p>
                    <p><strong>å¯æ‰§è¡Œ:</strong> <span id="detailReady"></span></p>
                </div>
            </div>

            <!-- Confirmation Process -->
            <div class="card full-width">
                <h2>âœï¸ ç¡®è®¤ & æ‰§è¡Œ</h2>

                <div class="input-group">
                    <label>é€‰æ‹©äº¤æ˜“ ID:</label>
                    <input type="number" id="actionTxId" placeholder="0" value="0">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <button class="btn-success" onclick="confirmTx()">âœ… ç¡®è®¤äº¤æ˜“</button>
                    <button class="btn-danger" onclick="revokeTx()">âŒ æ’¤é”€ç¡®è®¤</button>
                    <button class="btn-warning" onclick="executeTx()">âš¡ æ‰§è¡Œäº¤æ˜“</button>
                </div>

                <div id="thresholdNotification" class="notification warning" style="display: none;">
                    <strong>ğŸ”” é€šçŸ¥:</strong> <span id="notificationText"></span>
                </div>
            </div>

            <!-- Event Log -->
            <div class="card full-width">
                <h2>ğŸ“ äº‹ä»¶æ—¥å¿—</h2>
                <button class="btn-primary" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                <div id="eventLog" style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                    <div style="color: #999; text-align: center; padding: 20px;">
                        ç­‰å¾…äº‹ä»¶...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract ABIs
        const MULTISIG_ABI = [
            "function owners(uint256) view returns (address)",
            "function required() view returns (uint256)",
            "function getOwners() view returns (address[])",
            "function getTransactionCount() view returns (uint256)",
            "function getTransaction(uint256) view returns (address token, address to, uint256 value, bytes data, bool executed, uint256 numConfirmations)",
            "function isTransactionReady(uint256) view returns (bool)",
            "function getConfirmations(uint256) view returns (address[])",
            "function submitTransaction(address token, address to, uint256 value, bytes data)",
            "function confirmTransaction(uint256 txId)",
            "function revokeConfirmation(uint256 txId)",
            "function executeTransaction(uint256 txId)",
            "event SubmitTransaction(uint256 indexed txId, address indexed token, address indexed to, uint256 value, bytes data)",
            "event ConfirmTransaction(address indexed owner, uint256 indexed txId)",
            "event RevokeConfirmation(address indexed owner, uint256 indexed txId)",
            "event ExecuteTransaction(uint256 indexed txId)",
            "event ConfirmationThresholdReached(uint256 indexed txId, uint256 numConfirmations)"
        ];

        const ERC20_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function balanceOf(address) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function mint(address to, uint256 amount)"
        ];

        // Global state
        let provider;
        let signer;
        let currentAccount;
        let walletContract;
        let tokenContract;
        let eventLog = [];

        // Initialize
        window.addEventListener('load', () => {
            addLog('ç³»ç»Ÿ', 'Web3 dApp å·²åŠ è½½ï¼Œè¯·è¿æ¥ MetaMask');

            // Check if MetaMask is installed
            if (typeof window.ethereum !== 'undefined') {
                addLog('ç³»ç»Ÿ', 'æ£€æµ‹åˆ° MetaMask æ‰©å±•');
            } else {
                addLog('é”™è¯¯', 'æœªæ£€æµ‹åˆ° MetaMaskï¼Œè¯·å®‰è£… MetaMask æ‰©å±•');
            }
        });

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    // Show installation guide
                    const installMsg = `ğŸ¦Š æœªæ£€æµ‹åˆ° MetaMask é’±åŒ…æ‰©å±•ï¼\n\n` +
                        `MetaMask æ˜¯ä¸€ä¸ªæµè§ˆå™¨æ‰©å±•ï¼Œç”¨äºè¿æ¥åŒºå—é“¾åº”ç”¨ã€‚\n\n` +
                        `è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å®‰è£…ï¼š\n\n` +
                        `1. è®¿é—® MetaMask å®˜ç½‘: https://metamask.io/\n` +
                        `2. ç‚¹å‡» "Download" ä¸‹è½½é€‚åˆä½ æµè§ˆå™¨çš„ç‰ˆæœ¬\n` +
                        `3. å®‰è£…å®Œæˆåï¼Œåˆ·æ–°æ­¤é¡µé¢\n\n` +
                        `æ”¯æŒçš„æµè§ˆå™¨: Chrome, Firefox, Brave, Edge`;
                    alert(installMsg);
                    addLog('é”™è¯¯', 'æœªå®‰è£… MetaMaskï¼Œè¯·è®¿é—® https://metamask.io/ ä¸‹è½½å®‰è£…');
                    // Open MetaMask download page
                    window.open('https://metamask.io/download/', '_blank');
                    return;
                }

                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                currentAccount = await signer.getAddress();

                // Get network
                const network = await provider.getNetwork();

                // Update UI
                document.getElementById('walletConnection').textContent = 'âœ… å·²è¿æ¥';
                document.getElementById('currentAccount').textContent = currentAccount;
                document.getElementById('network').textContent = `${network.name} (Chain ID: ${network.chainId})`;
                document.getElementById('connectBtn').textContent = 'âœ… å·²è¿æ¥';
                document.getElementById('connectBtn').disabled = true;

                addLog('è¿æ¥', `å·²è¿æ¥è´¦æˆ·: ${currentAccount}`);
                addLog('ç½‘ç»œ', `${network.name} (Chain ID: ${network.chainId})`);

                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        addLog('æ–­å¼€', 'è´¦æˆ·å·²æ–­å¼€');
                        location.reload();
                    } else {
                        currentAccount = accounts[0];
                        document.getElementById('currentAccount').textContent = currentAccount;
                        addLog('åˆ‡æ¢', `åˆ‡æ¢åˆ°è´¦æˆ·: ${currentAccount}`);
                        refreshState();
                    }
                });

                // Listen for chain changes
                window.ethereum.on('chainChanged', () => {
                    location.reload();
                });

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `è¿æ¥å¤±è´¥: ${error.message}`);
                alert('è¿æ¥ MetaMask å¤±è´¥: ' + error.message);
            }
        }

        async function loadContracts() {
            try {
                if (!signer) {
                    alert('è¯·å…ˆè¿æ¥ MetaMask');
                    return;
                }

                const walletAddr = document.getElementById('walletAddress').value.trim();
                const tokenAddr = document.getElementById('tokenAddress').value.trim();

                if (!walletAddr || !tokenAddr) {
                    alert('è¯·å¡«å…¥åˆçº¦åœ°å€');
                    return;
                }

                // Load contracts
                walletContract = new ethers.Contract(walletAddr, MULTISIG_ABI, signer);
                tokenContract = new ethers.Contract(tokenAddr, ERC20_ABI, signer);

                addLog('åˆçº¦', `MultiSigWallet å·²åŠ è½½: ${walletAddr}`);
                addLog('åˆçº¦', `MockERC20 å·²åŠ è½½: ${tokenAddr}`);

                // Setup event listeners
                setupEventListeners();

                // Refresh state
                await refreshState();

                alert('åˆçº¦åŠ è½½æˆåŠŸï¼');

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `åŠ è½½åˆçº¦å¤±è´¥: ${error.message}`);
                alert('åŠ è½½åˆçº¦å¤±è´¥: ' + error.message);
            }
        }

        function setupEventListeners() {
            // Listen for ConfirmationThresholdReached event
            walletContract.on("ConfirmationThresholdReached", (txId, numConfirmations) => {
                addLog('äº‹ä»¶', `ğŸ”” äº¤æ˜“ #${txId} å·²è¾¾åˆ°é˜ˆå€¼! (${numConfirmations} ä¸ªç¡®è®¤)`);
                showNotification(`äº¤æ˜“ #${txId} å·²è¾¾åˆ°é˜ˆå€¼ï¼Œå¯ä»¥æ‰§è¡Œäº†ï¼`);
                refreshState();
            });

            // Listen for other events
            walletContract.on("SubmitTransaction", (txId, token, to, value, data) => {
                addLog('äº‹ä»¶', `æäº¤äº¤æ˜“ #${txId} (å‘é€ ${ethers.utils.formatEther(value)} MTK åˆ° ${to})`);
                refreshState();
            });

            walletContract.on("ConfirmTransaction", (owner, txId) => {
                addLog('äº‹ä»¶', `${owner} ç¡®è®¤äº†äº¤æ˜“ #${txId}`);
                refreshState();
            });

            walletContract.on("RevokeConfirmation", (owner, txId) => {
                addLog('äº‹ä»¶', `${owner} æ’¤é”€äº†äº¤æ˜“ #${txId} çš„ç¡®è®¤`);
                refreshState();
            });

            walletContract.on("ExecuteTransaction", (txId) => {
                addLog('äº‹ä»¶', `âœ… äº¤æ˜“ #${txId} å·²æ‰§è¡Œ`);
                refreshState();
            });
        }

        async function refreshState() {
            try {
                if (!walletContract || !tokenContract) {
                    return;
                }

                // Get wallet info
                const owners = await walletContract.getOwners();
                const required = await walletContract.required();
                const txCount = await walletContract.getTransactionCount();

                document.getElementById('ownerCount').textContent = owners.length;
                document.getElementById('requiredSigs').textContent = `${required} of ${owners.length}`;
                document.getElementById('txCount').textContent = txCount.toString();

                // Get balances
                const walletBalance = await tokenContract.balanceOf(walletContract.address);
                const userBalance = await tokenContract.balanceOf(currentAccount);

                document.getElementById('walletBalance').textContent = ethers.utils.formatEther(walletBalance);
                document.getElementById('userBalance').textContent = ethers.utils.formatEther(userBalance);

                addLog('åˆ·æ–°', 'çŠ¶æ€å·²æ›´æ–°');

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `åˆ·æ–°çŠ¶æ€å¤±è´¥: ${error.message}`);
            }
        }

        async function submitTransaction() {
            try {
                if (!walletContract || !tokenContract) {
                    alert('è¯·å…ˆåŠ è½½åˆçº¦');
                    return;
                }

                const recipient = document.getElementById('recipientAddress').value.trim();
                const amount = document.getElementById('transferAmount').value;

                if (!recipient || !amount) {
                    alert('è¯·å¡«å†™æ¥æ”¶åœ°å€å’Œé‡‘é¢');
                    return;
                }

                addLog('æäº¤', 'æ­£åœ¨æäº¤äº¤æ˜“...');

                const amountWei = ethers.utils.parseEther(amount);
                const tx = await walletContract.submitTransaction(
                    tokenContract.address,
                    recipient,
                    amountWei,
                    "0x"
                );

                addLog('äº¤æ˜“', `äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`);

                const receipt = await tx.wait();
                addLog('æˆåŠŸ', 'äº¤æ˜“å·²æäº¤ï¼');

                await refreshState();

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `æäº¤å¤±è´¥: ${error.message}`);
                alert('æäº¤äº¤æ˜“å¤±è´¥: ' + error.message);
            }
        }

        async function queryTransaction() {
            try {
                if (!walletContract) {
                    alert('è¯·å…ˆåŠ è½½åˆçº¦');
                    return;
                }

                const txId = document.getElementById('queryTxId').value;

                const tx = await walletContract.getTransaction(txId);
                const isReady = await walletContract.isTransactionReady(txId);

                document.getElementById('detailTo').textContent = tx.to;
                document.getElementById('detailValue').textContent = ethers.utils.formatEther(tx.value);
                document.getElementById('detailConfirmations').textContent = tx.numConfirmations.toString();
                document.getElementById('detailExecuted').textContent = tx.executed ? 'âœ… æ˜¯' : 'âŒ å¦';
                document.getElementById('detailReady').textContent = isReady ? 'âœ… æ˜¯' : 'âŒ å¦';

                document.getElementById('txDetails').style.display = 'block';

                addLog('æŸ¥è¯¢', `äº¤æ˜“ #${txId} è¯¦æƒ…å·²æ˜¾ç¤º`);

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `æŸ¥è¯¢å¤±è´¥: ${error.message}`);
                alert('æŸ¥è¯¢äº¤æ˜“å¤±è´¥: ' + error.message);
            }
        }

        async function confirmTx() {
            try {
                if (!walletContract) {
                    alert('è¯·å…ˆåŠ è½½åˆçº¦');
                    return;
                }

                const txId = document.getElementById('actionTxId').value;

                addLog('ç¡®è®¤', `æ­£åœ¨ç¡®è®¤äº¤æ˜“ #${txId}...`);

                const tx = await walletContract.confirmTransaction(txId);
                addLog('äº¤æ˜“', `äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`);

                await tx.wait();
                addLog('æˆåŠŸ', `äº¤æ˜“ #${txId} å·²ç¡®è®¤ï¼`);

                await refreshState();

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `ç¡®è®¤å¤±è´¥: ${error.message}`);
                alert('ç¡®è®¤äº¤æ˜“å¤±è´¥: ' + error.message);
            }
        }

        async function revokeTx() {
            try {
                if (!walletContract) {
                    alert('è¯·å…ˆåŠ è½½åˆçº¦');
                    return;
                }

                const txId = document.getElementById('actionTxId').value;

                addLog('æ’¤é”€', `æ­£åœ¨æ’¤é”€äº¤æ˜“ #${txId} çš„ç¡®è®¤...`);

                const tx = await walletContract.revokeConfirmation(txId);
                addLog('äº¤æ˜“', `äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`);

                await tx.wait();
                addLog('æˆåŠŸ', `äº¤æ˜“ #${txId} çš„ç¡®è®¤å·²æ’¤é”€ï¼`);

                await refreshState();

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `æ’¤é”€å¤±è´¥: ${error.message}`);
                alert('æ’¤é”€ç¡®è®¤å¤±è´¥: ' + error.message);
            }
        }

        async function executeTx() {
            try {
                if (!walletContract) {
                    alert('è¯·å…ˆåŠ è½½åˆçº¦');
                    return;
                }

                const txId = document.getElementById('actionTxId').value;

                addLog('æ‰§è¡Œ', `æ­£åœ¨æ‰§è¡Œäº¤æ˜“ #${txId}...`);

                const tx = await walletContract.executeTransaction(txId);
                addLog('äº¤æ˜“', `äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`);

                await tx.wait();
                addLog('æˆåŠŸ', `âœ… äº¤æ˜“ #${txId} å·²æ‰§è¡Œï¼`);

                await refreshState();

            } catch (error) {
                console.error(error);
                addLog('é”™è¯¯', `æ‰§è¡Œå¤±è´¥: ${error.message}`);
                alert('æ‰§è¡Œäº¤æ˜“å¤±è´¥: ' + error.message);
            }
        }

        function addLog(action, details) {
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            eventLog.unshift(`[${timestamp}] ${action}: ${details}`);
            updateEventLog();
        }

        function updateEventLog() {
            const logDiv = document.getElementById('eventLog');
            if (eventLog.length === 0) {
                logDiv.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">ç­‰å¾…äº‹ä»¶...</div>';
            } else {
                logDiv.innerHTML = eventLog.map(e =>
                    `<div style="padding: 8px; border-bottom: 1px solid #eee; font-family: monospace; font-size: 0.9em;">${e}</div>`
                ).join('');
            }
        }

        function clearLog() {
            eventLog = [];
            updateEventLog();
        }

        function showNotification(message) {
            const notif = document.getElementById('thresholdNotification');
            document.getElementById('notificationText').textContent = message;
            notif.style.display = 'block';

            setTimeout(() => {
                notif.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
